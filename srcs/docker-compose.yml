version: "3.9"

services:
  mariadb:
    build: ./requirements/mariadb
    container_name: mariadb
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - db_volume:/var/lib/mysql
    networks:
      - inception_net

  redis:
    build: ./requirements/bonus/redis
    container_name: redis
    restart: unless-stopped
    networks:
      - inception_net

  wordpress:
    build: ./requirements/wordpress
    container_name: wordpress
    restart: unless-stopped
    environment:
      WORDPRESS_DB_HOST: mariadb:3306
      WORDPRESS_DB_USER: ${MYSQL_USER}
      WORDPRESS_DB_PASSWORD: ${MYSQL_PASSWORD}
      WORDPRESS_DB_NAME: ${MYSQL_DATABASE}
      REDIS_HOST: redis
    volumes:
      - wp_volume:/var/www/html
    networks:
      - inception_net
    depends_on:
      - mariadb
      - redis

  nginx:
    build: ./requirements/nginx
    container_name: nginx
    restart: unless-stopped
    ports:
      - "443:443"
    volumes:
      - wp_volume:/var/www/html
    networks:
      - inception_net
    depends_on:
      - wordpress

  ftp:
    build: ./requirements/bonus/ftp
    container_name: ftp
    restart: unless-stopped
    ports:
      - "21:21"
      - "21100-21110:21100-21110"
    environment:
      FTP_USER: ${FTP_USER}
      FTP_PASSWORD: ${FTP_PASSWORD}
    volumes:
      - wp_volume:/var/www/html
    networks:
      - inception_net
    depends_on:
      - wordpress

  static-site:
    build: ./requirements/bonus/static-site
    container_name: static-site
    restart: unless-stopped
    ports:
      - "8080:8080"
    networks:
      - inception_net

  adminer:
    build: ./requirements/bonus/adminer
    container_name: adminer
    restart: unless-stopped
    ports:
      - "8081:8081"
    networks:
      - inception_net
    depends_on:
      - mariadb

  portainer:
    build: ./requirements/bonus/portainer
    container_name: portainer
    restart: unless-stopped
    ports:
      - "9000:9000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    networks:
      - inception_net

volumes:
  db_volume:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /home/chris/data/mariadb
  
  wp_volume:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /home/chris/data/wordpress

  portainer_data:
    driver: local

networks:
  inception_net:
    driver: bridge

# ###################
# un archivo que dice:
# ‚ÄúEstos contenedores existen, as√≠ se construyen, 
# as√≠ se conectan y as√≠ se arrancan juntos‚Äù.
# Con un solo comando (docker compose up) Docker levanta todo.
# ###################
# Docker Compose ‚Äì Arquitectura del proyecto Inception
# üì¶ Servicios
# üîπ MariaDB
# Contenedor: mariadb
# Funci√≥n: Base de datos de WordPress
# Variables cargadas desde .env
# Volumen persistente:
# db_volume ‚Üí /var/lib/mysql
# Red: inception_net
# 
# üîπ WordPress (PHP-FPM)
# Contenedor: wordpress
# Funci√≥n: Ejecutar WordPress con PHP-FPM
# Se conecta a MariaDB mediante:
# WORDPRESS_DB_HOST=mariadb:3306
# Volumen compartido:
# wp_volume ‚Üí /var/www/html
# Puerto interno:
# 9000 (PHP-FPM)
# Depende de:
# mariadb
# 
# üîπ Nginx
# Contenedor: nginx
# Funci√≥n: Servidor web + HTTPS
# Puerto expuesto:
# 443 (SSL)
# Comparte archivos con WordPress:
# wp_volume
# Redirige PHP a:
# wordpress:9000
# Depende de:
# wordpress
# 
# üóÑÔ∏è Vol√∫menes
# Volumen	Uso
# db_volume	Persistencia de la base de datos
# wp_volume	Archivos de WordPress compartidos
# üåê Red
# 
# Red privada Docker: inception_net
# Tipo: bridge
# Permite comunicaci√≥n interna entre contenedores
# No expone servicios directamente al host (excepto Nginx)
# ###################
